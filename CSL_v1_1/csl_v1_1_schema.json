{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/csl-1.1.schema.json",
  "title": "CSL (CAD-Specific Language) JSON IR v1.1",
  "description": "Version 1.1 adds export/thumbnail operations and backend capabilities",
  "type": "object",
  "required": ["csl", "meta"],
  "properties": {
    "csl": {
      "type": "string",
      "const": "1.1",
      "description": "CSL version (1.1 adds export/thumbnail)"
    },
    "meta": {
      "type": "object",
      "required": ["name", "units"],
      "properties": {
        "name": {"type": "string"},
        "author": {"type": "string"},
        "units": {
          "type": "string",
          "enum": ["mm", "in", "cm", "m", "ft", "deg", "rad"]
        },
        "backend": {
          "type": "object",
          "properties": {
            "targets": {
              "type": "array",
              "items": {"type": "string"}
            },
            "require": {
              "type": "object",
              "properties": {
                "features": {"type": "array", "items": {"type": "string"}},
                "queries": {"type": "array", "items": {"type": "string"}}
              }
            }
          }
        }
      }
    },
    "params": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["id", "type", "value"],
        "properties": {
          "id": {"type": "string"},
          "type": {
            "type": "string",
            "enum": ["length", "angle", "count", "bool", "real"]
          },
          "value": {"type": "string"},
          "range": {
            "type": "array",
            "items": {"type": "string"},
            "minItems": 2,
            "maxItems": 2
          }
        }
      }
    },
    "sketches": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["id", "plane", "entities"],
        "properties": {
          "id": {"type": "string"},
          "plane": {"type": "string"},
          "entities": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["kind", "id"],
              "properties": {
                "kind": {
                  "type": "string",
                  "enum": ["point", "line", "arc", "circle", "rect", "slot", "polyline"]
                },
                "id": {"type": "string"},
                "construction": {"type": "boolean"},
                "p1": {"type": "string"},
                "p2": {"type": "string"},
                "center": {"type": "string"},
                "d": {"type": "string"},
                "r": {"type": "string"},
                "points": {
                  "type": "array",
                  "items": {"type": "string"}
                }
              }
            }
          },
          "constraints": {
            "type": "array",
            "items": {"type": "object"}
          },
          "dims": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["kind"],
              "properties": {
                "id": {"type": "string"},
                "name": {"type": "string"},
                "kind": {
                  "type": "string",
                  "enum": ["horizontal", "vertical", "distance", "diameter", "radius", "angle"]
                },
                "mode": {
                  "type": "string",
                  "enum": ["driving", "reference"]
                },
                "value": {"type": "string"}
              }
            }
          }
        }
      }
    },
    "features": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["kind", "id"],
        "properties": {
          "kind": {
            "type": "string",
            "enum": [
              "extrude", "revolve", "sweep", "loft", "shell",
              "fillet", "chamfer", "draft", "move_face", "offset_face",
              "replace_face", "thin_extrude", "rib", "wrap", "split",
              "mirror", "pattern", "boolean", "hole", "thread", "helix"
            ]
          },
          "id": {"type": "string"},
          "profile": {"type": "string"},
          "distance": {"type": "string"},
          "operation": {
            "type": "string",
            "enum": ["new_solid", "add", "cut", "intersect"]
          },
          "result": {"type": "string"},
          "edges": {"type": "string"},
          "faces": {"type": "string"},
          "radius": {"type": "string"},
          "angle": {"type": "string"},
          "axis": {"type": "string"},
          "count": {"type": "integer"},
          "spacing": {"type": "string"}
        }
      }
    },
    "export": {
      "type": "array",
      "description": "Export operations (new in v1.1)",
      "items": {
        "type": "object",
        "required": ["id", "format", "path"],
        "properties": {
          "id": {"type": "string"},
          "format": {
            "type": "string",
            "enum": ["STEP", "STL", "IGES", "SAT", "BREP", "3MF", "OBJ"]
          },
          "path": {"type": "string"},
          "target": {
            "type": "string",
            "description": "Feature ID to export, default 'all'"
          },
          "resolution": {
            "type": "string",
            "enum": ["coarse", "medium", "fine", "adaptive"],
            "description": "For mesh formats"
          },
          "units": {
            "type": "string",
            "description": "Override file units for export"
          },
          "version": {
            "type": "string",
            "description": "Format version if applicable"
          }
        }
      }
    },
    "thumbnail": {
      "type": "array",
      "description": "Thumbnail/preview operations (new in v1.1)",
      "items": {
        "type": "object",
        "required": ["id", "path"],
        "properties": {
          "id": {"type": "string"},
          "path": {"type": "string"},
          "width": {
            "type": "integer",
            "default": 512,
            "minimum": 64,
            "maximum": 4096
          },
          "height": {
            "type": "integer",
            "default": 384,
            "minimum": 64,
            "maximum": 4096
          },
          "view": {
            "type": "string",
            "enum": ["iso", "top", "bottom", "front", "back", "left", "right"],
            "default": "iso"
          },
          "style": {
            "type": "string",
            "enum": ["shaded", "wireframe", "hidden", "rendered"],
            "default": "shaded"
          },
          "background": {
            "type": "string",
            "description": "Color or 'transparent'"
          }
        }
      }
    },
    "materials": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["target", "name"],
        "properties": {
          "target": {"type": "string"},
          "name": {"type": "string"},
          "density": {"type": "string"},
          "color": {"type": "string"}
        }
      }
    },
    "properties": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["target"],
        "properties": {
          "target": {"type": "string"},
          "finish": {"type": "string"},
          "tolerance_class": {"type": "string"},
          "drawing": {"type": "string"}
        }
      }
    },
    "assemblies": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["id"],
        "properties": {
          "id": {"type": "string"},
          "instances": {"type": "array"},
          "mates": {"type": "array"}
        }
      }
    },
    "ecad": {
      "type": "object",
      "properties": {
        "library": {"type": "object"},
        "netlist": {"type": "object"},
        "board": {"type": "object"},
        "placement": {"type": "object"},
        "routing_hints": {"type": "object"}
      }
    },
    "capabilities": {
      "type": "object",
      "description": "Backend capability declaration (new in v1.1)",
      "properties": {
        "backend": {"type": "string"},
        "version": {"type": "string"},
        "supports": {
          "type": "object",
          "properties": {
            "brep": {"type": "boolean"},
            "mesh": {"type": "boolean"},
            "params": {"type": "boolean"},
            "queries": {"type": "boolean"},
            "features": {
              "type": "object",
              "additionalProperties": {
                "oneOf": [
                  {"type": "boolean"},
                  {"type": "array", "items": {"type": "string"}}
                ]
              }
            },
            "export": {
              "type": "array",
              "items": {"type": "string"}
            },
            "thumbnail": {
              "type": "object",
              "properties": {
                "enabled": {"type": "boolean"},
                "views": {"type": "array", "items": {"type": "string"}},
                "styles": {"type": "array", "items": {"type": "string"}}
              }
            }
          }
        }
      }
    }
  }
}